{{ define "index" }}
<!DOCTYPE html>
<html lang="fr">
<head>
    {{ template "head" . }}
    <style>
        {{.theme | safeCSS}}
    </style>
    <link rel="stylesheet" href="/static/css/header.css">
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/cookie.css">
    <link rel="stylesheet" href="/static/css/footer.css">
    <link rel="stylesheet" href="/static/css/index.css">
</head>
<body>
    {{ template "public_header" . }}
    {{ template "cookie_content" . }}
    <main class="main">
        {{ template "index_content" . }}
    </main>
    <script src="static/js/cookie.js"></script> 
    <script src="static/js/common.js"></script>
    {{ template "footer" . }}
    {{ template "index_scripts" . }}
</body>
</html>
{{ end }}
{{ define "index_content" }}
<!-- Main Content -->
<div class="container">
    <!-- Articles Section avec Alpine.js pour infinite scroll -->
    <section class="articles-section" 
             x-data="infiniteScroll('{{ .category }}', {{ .isAuthenticated }})"
             x-init="init()">
        <br/>
        
        <!-- Conteneur des articles -->
        <div class="articles-grid" id="articles-container">
            <!-- Les articles seront charg√©s dynamiquement ici -->
        </div>

        <!-- Loader pendant le chargement -->
        <div class="loader" x-show="loading" x-cloak>
            <div class="loader-spinner"></div>
            <p>Chargement des articles...</p>
        </div>

        <!-- Message quand il n'y a plus d'articles -->
        <div class="no-more-posts" x-show="!hasMore && !loading && posts.length > 0" x-cloak>
            <p>üéâ Vous avez tout lu !</p>
        </div>

        <!-- √âtat vide -->
        <div class="empty-state" x-show="posts.length === 0 && !loading" x-cloak>
            <div class="empty-icon">üìù</div>
            <h3>Aucun article pour le moment</h3>
            <p>Restez connect√©s, du contenu arrive bient√¥t !</p>
        </div>

        <!-- Sentinel pour d√©clencher le chargement -->
        <div id="scroll-sentinel" x-ref="sentinel"></div>
    </section>
</div>

<!-- Template pour un article (cach√©, utilis√© par JS) -->
<template id="article-template">
    <article class="article-card">
        <header class="article-header">
            <h3 class="article-title">
                <a href="" data-href></a>
            </h3>
            <div class="article-meta">
                <div class="meta-item">
                    <span>üë§</span>
                    <span data-author></span>
                </div>
                <div class="meta-item">
                    <span>üìÖ</span>
                    <span data-date></span>
                </div>
            </div>
        </header>

        <div class="article-content">
            <p class="article-excerpt" data-excerpt></p>
            
            <div class="article-tags" data-tags></div>

            <div class="article-actions">
                <a href="" class="read-more" data-readmore>
                    Lire la suite ‚Üí
                </a>
                <div class="article-stats">
                    <div class="stat">
                        <span>‚ù§Ô∏è</span>
                        <span data-likes>0</span>
                    </div>
                    <div class="stat">
                        <span>üí¨</span>
                        <span data-comments>0</span>
                    </div>
                </div>
            </div>

            <div class="admin-actions" data-admin style="display: none;">
                <a href="" class="btn-admin" data-edit>‚úèÔ∏è √âditer</a>
            </div>
        </div>
    </article>
</template>

<!-- Template pour le skeleton loader -->
<template id="skeleton-template">
    <div class="article-skeleton">
        <div class="skeleton-header">
            <div class="skeleton-title"></div>
            <div class="skeleton-meta">
                <div class="skeleton-meta-item"></div>
                <div class="skeleton-meta-item"></div>
            </div>
        </div>
        <div class="skeleton-content">
            <div class="skeleton-text"></div>
            <div class="skeleton-text"></div>
            <div class="skeleton-text"></div>
        </div>
    </div>
</template>
{{ end }}
{{ define "index_scripts" }}
<script>
function infiniteScroll(category, isAuthenticated) {
    return {
        category: category,
        isAuthenticated: isAuthenticated,
        posts: [],
        loading: false,
        hasMore: true,
        page: 1,
        perPage: 5,
        observer: null,
        
        async init() {
            // Charger les premiers articles
            await this.loadPosts();
            
            // Configurer l'Intersection Observer
            this.setupObserver();
        },
        
        setupObserver() {
            const options = {
                root: null,
                rootMargin: '100px',
                threshold: 0.1
            };
            
            this.observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !this.loading && this.hasMore) {
                        this.loadPosts();
                    }
                });
            }, options);
            
            // Observer le sentinel
            if (this.$refs.sentinel) {
                this.observer.observe(this.$refs.sentinel);
            }
        },
        
        async loadPosts() {
            if (this.loading || !this.hasMore) return;
            
            this.loading = true;
            
            // Afficher des skeletons pendant le chargement
            this.showSkeletons();
            
            try {
                // Appel API pour r√©cup√©rer les articles
                const response = await fetch(`/api/posts?page=${this.page}&limit=${this.perPage}&category=${this.category}`);
                const data = await response.json();
                
                // Retirer les skeletons
                this.removeSkeletons();
                
                if (data.posts && data.posts.length > 0) {
                    // Ajouter les nouveaux articles
                    data.posts.forEach(post => {
                        this.renderArticle(post);
                        this.posts.push(post);
                    });
                    
                    this.page++;
                    this.hasMore = data.hasMore || (data.posts.length === this.perPage);
                } else {
                    this.hasMore = false;
                }
            } catch (error) {
                console.error('Erreur lors du chargement des articles:', error);
                this.removeSkeletons();
            } finally {
                this.loading = false;
            }
        },

        renderArticle(post) {
            const template = document.getElementById('article-template');
            const clone = template.content.cloneNode(true);
            const article = clone.querySelector('.article-card');
            
            // Remplir les donn√©es
            const titleLink = article.querySelector('[data-href]');
            titleLink.href = `/post/${post.ID || post.id}`;
            titleLink.textContent = post.title;
            
            article.querySelector('[data-author]').textContent = post.author || 'Anonyme';
            article.querySelector('[data-date]').textContent = this.formatDate(post.created_at);
            article.querySelector('[data-excerpt]').textContent = post.excerpt || '';
            article.querySelector('[data-likes]').textContent = post.like_count || 0;
            article.querySelector('[data-comments]').textContent = (post.comments || []).length;
            
            const readMore = article.querySelector('[data-readmore]');
            readMore.href = `/post/${post.ID || post.id}`;
            
            // Tags
            const tagsContainer = article.querySelector('[data-tags]');
            const tags = post.TagsList || post.tagsList || [];
            tags.forEach(tag => {
                const tagEl = document.createElement('span');
                tagEl.className = 'tag';
                tagEl.textContent = tag;
                tagsContainer.appendChild(tagEl);
            });
            
            // Admin actions
            if (this.isAuthenticated) {
                const adminSection = article.querySelector('[data-admin]');
                adminSection.style.display = 'block';
                const editLink = article.querySelector('[data-edit]');
                editLink.href = `/admin/posts/${post.ID || post.id}/edit`;
            }
            
            // Ajouter au conteneur
            document.getElementById('articles-container').appendChild(clone);
        },
        
        showSkeletons() {
            const template = document.getElementById('skeleton-template');
            const container = document.getElementById('articles-container');
            
            for (let i = 0; i < 2; i++) {
                const clone = template.content.cloneNode(true);
                const skeleton = clone.querySelector('.article-skeleton');
                skeleton.classList.add('skeleton-loader');
                container.appendChild(clone);
            }
        },
        
        removeSkeletons() {
            const skeletons = document.querySelectorAll('.skeleton-loader');
            skeletons.forEach(skeleton => skeleton.remove());
        },
        
        formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }
    };
}
document.head.insertAdjacentHTML('beforeend', '<style>[x-cloak] { display: none !important; }</style>');
</script>
{{ end }}