{{ define "posts" }}
<!DOCTYPE html>
<html lang="fr">
<head>
    {{ template "head" . }}
    <style>
        {{.theme | safeCSS}}
    </style>
    <link rel="stylesheet" href="/static/css/header.css">
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/footer.css">
    <link rel="stylesheet" href="/static/css/posts.css">
</head>
<body>
    {{ template "public_header" . }}
    <main class="main">
        {{ template "posts_content" . }}
    </main>
    {{ template "footer" . }}
    {{ template "posts_scripts" . }}
    <script src="static/js/common.js"></script>
</body>
</html>
{{ end }}
{{ define "posts_content" }}
<div class="container">
    <br/>
    <article class="article-card fade-in">
        <header class="article-header">
            <h1 class="article-title">{{ .post.Title }}</h1>
            <div class="article-meta">
                <div class="meta-item">
                    <span>üìù</span>
                    <span>Par <strong>{{ .post.Author }}</strong></span>
                </div>
                <div class="meta-item">
                    <span>üìÖ</span>
                    <span>{{ .post.CreatedAt.Format "02/01/2006 √† 15:04" }}</span>
                </div>
            </div>
            {{- if .post.TagsList }}
            <div class="article-tags">
                {{- range .post.TagsList }}
                <span class="tag">{{ . }}</span>
                {{- end }}
            </div>
            {{- end }}
        </header>

        <div class="article-content">
            {{ .post.ContentHTML }}
        </div>

        <!-- Actions avec Alpine.js -->
        <div x-data="postInteractions({{ .post.ID }})">
            <div class="actions">
                <button @click="toggleLike" 
                        :class="{ 'liked': isLiked }"
                        class="btn btn-primary btn-like">
                    <span x-show="!isLiked">ü§ç</span>
                    <span x-show="isLiked">‚ù§Ô∏è</span>
                    <span x-text="likeCount + ' likes'"></span>
                </button>
                
                <button @click="showComments = !showComments" 
                        class="btn btn-outline">
                    <span>üí¨</span>
                    <span x-text="comments.length + ' commentaires'"></span>
                </button>
            </div>

            <!-- Actions administrateur -->
            {{- if .isAuthenticated }}
            <div class="admin-actions">
                <h4 style="margin-bottom: 15px; color: var(--dark-color);">üîê Actions Administrateur</h4>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <a href="/admin/posts/{{ .post.ID }}/edit" class="btn btn-warning">
                        ‚úèÔ∏è √âditer cet article
                    </a>
                    <a href="/admin/posts" class="btn btn-primary">
                        üìù G√©rer tous les articles
                    </a>
                </div>
            </div>
            {{- end }}

            <!-- Section commentaires -->
            <div x-show="showComments" 
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform scale-95"
                 x-transition:enter-end="opacity-100 transform scale-100"
                 class="comments-section fade-in">
                
                <div class="comments-header">
                    <span x-text="'üí¨ Commentaires (' + comments.length + ')'"></span>
                </div>

                <div class="comments-list">
                    <template x-for="comment in comments" :key="comment.id">
                        <div class="comment">
                            <div class="comment-header">
                                <span class="comment-author" x-text="comment.author"></span>
                                <span class="comment-date" x-text="formatDate(comment.created_at)"></span>
                            </div>
                            <div class="comment-content" x-text="comment.content"></div>
                        </div>
                    </template>

                    <div x-show="comments.length === 0" class="no-comments">
                        <p>‚ú® Aucun commentaire pour le moment.</p>
                        <p>Soyez le premier √† partager votre avis !</p>
                    </div>
                </div>

                <!-- Formulaire d'ajout -->
                <form @submit.prevent="addComment" 
                      class="comment-form"
                      :class="{ 'loading': loading }">
                    <h4 style="margin-bottom: 25px; color: var(--dark-color);">üí≠ Ajouter un commentaire</h4>
                    
                    <div class="form-group">
                        <label class="form-label" for="author">Votre nom</label>
                        <input x-model="newComment.author" 
                               id="author"
                               type="text" 
                               class="form-control"
                               placeholder="Entrez votre nom"
                               required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="content">Votre commentaire</label>
                        <textarea x-model="newComment.content"
                                  id="content"
                                  class="form-control"
                                  placeholder="Partagez vos pens√©es..."
                                  required></textarea>
                    </div>

                    <button type="submit" 
                            :disabled="loading || !newComment.author.trim() || !newComment.content.trim()"
                            class="btn btn-primary">
                        <span x-show="!loading">üöÄ Publier le commentaire</span>
                        <span x-show="loading">‚è≥ Publication en cours...</span>
                    </button>
                </form>
            </div>
        </div>
    </article>
</div>
{{ end }}
{{ define "posts_scripts" }}
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('postInteractions', (postId) => ({
        postId: postId,
        comments: [],
        showComments: false,
        likeCount: 0,
        isLiked: false,
        loading: false,
        newComment: {
            author: '',
            content: ''
        },

        async init() {
            await this.loadComments();
            await this.loadLikeStatus();
        },

        async loadComments() {
            try {
                const response = await fetch(`/api/posts/${this.postId}/comments`);
                if (response.ok) {
                    this.comments = await response.json();
                }
            } catch (error) {
                console.error('Erreur chargement commentaires:', error);
                window.showNotification('Erreur lors du chargement des commentaires', 'error');
            }
        },

        async loadLikeStatus() {
            try {
                const response = await fetch(`/api/posts/${this.postId}/like-status`);
                if (response.ok) {
                    const data = await response.json();
                    this.isLiked = data.liked;
                    this.likeCount = data.like_count;
                }
            } catch (error) {
                console.error('Erreur chargement likes:', error);
            }
        },

        async addComment() {
            if (!this.newComment.author.trim() || !this.newComment.content.trim()) {
                window.showNotification('Veuillez remplir tous les champs', 'error');
                return;
            }

            this.loading = true;
            try {
                const response = await fetch(`/api/posts/${this.postId}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(this.newComment)
                });

                if (response.ok) {
                    const comment = await response.json();
                    this.comments.push(comment);
                    this.newComment = { author: '', content: '' };
                    window.showNotification('Commentaire ajout√© avec succ√®s !', 'success');
                } else {
                    const error = await response.json();
                    window.showNotification('Erreur: ' + error.error, 'error');
                }
            } catch (error) {
                console.error('Erreur ajout commentaire:', error);
                window.showNotification('Erreur lors de l\'ajout du commentaire', 'error');
            } finally {
                this.loading = false;
            }
        },

        async toggleLike() {
            try {
                const response = await fetch(`/api/posts/${this.postId}/like`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.isLiked = data.liked;
                    this.likeCount = data.like_count;
                }
            } catch (error) {
                console.error('Erreur like:', error);
                window.showNotification('Erreur lors du like', 'error');
            }
        },

        formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: 'long', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    }));
});
</script>
{{ end }}