{{ define "admin_post_form" }}
<!DOCTYPE html>
<html lang="fr">
<head>
    {{ template "head" . }}
    <style>
        {{.theme | safeCSS}}
    </style>
    <link rel="stylesheet" href="/files/css/admin_header.css?{{ .BuildID }}">
    <link rel="stylesheet" href="/files/css/common.css?{{ .BuildID }}">
    <link rel="stylesheet" href="/files/css/footer.css?{{ .BuildID }}">
    <link rel="stylesheet" href="/files/css/admin_post.css?{{ .BuildID }}">
</head>
<body>
    {{ template "admin_header" . }}
    <main class="main">
        {{ template "admin_post_form_content" . }}
    </main>
    {{ template "footer" . }}
    {{ template "admin_post_form_scripts" . }}
    <script src="/files/js/common.js?{{ .BuildID }}"></script>
</body>
</html>
{{ end }}
{{ define "admin_post_form_content" }}
<div class="container" x-data="postForm">
    <div class="page-header">
        <h1 class="page-title">{{ if .isEdit }}<img src="/files/img/pencil.svg" class="icon"> Éditer l'article{{ else }}<img src="/files/img/plus.svg" class="icon"> Créer un nouvel article{{ end }}</h1>
        <div class="header-actions">
            <a href="/admin/posts" class="btn btn-primary">← Retour à la liste</a>
            {{ if .isEdit }}
            <a href="/post/{{ .post.ID }}" target="_blank" class="btn btn-success"><img src="/files/img/eye.svg" class="icon"> Voir l'article</a>
            {{ end }}
        </div>
    </div>

    <form @submit.prevent="savePost">
        <div class="form-container">
            <div class="form-main">
                <!-- Titre -->
                <div class="form-group">
                    <label class="form-label" for="title"><img src="/files/img/memo.svg" class="icon"> Titre de l'article *</label>
                    <input x-model="post.title" 
                           id="title" 
                           type="text" 
                           class="form-control form-control-lg"
                           placeholder="Entrez un titre accrocheur pour votre article"
                           required>
                    <div class="form-help">Le titre apparaît sur la page d'accueil et dans les résultats de recherche</div>
                </div>

                <!-- Extrait -->
                <div class="form-group">
                    <label class="form-label" for="excerpt"><img src="/files/img/note.svg" class="icon"> Résumé/Extrait</label>
                    <textarea x-model="post.excerpt" 
                              id="excerpt" 
                              class="form-control"
                              rows="4"
                              placeholder="Résumé optionnel, si vide, il sera généré automatiquement a partir du contenu."></textarea>
                    <div class="form-help">Affiché sur la page d'accueil et dans les résultats de recherche. Si vide, l'extrait sera fait automatiquement a partir du contenu.</div>
                </div>

                <!-- Contenu -->
                <div class="form-group">
    <label class="form-label" for="content"><img src="/files/img/openbook.svg" class="icon"> Contenu (Markdown) *</label>
    
    <!-- Barre d'outils pour l'éditeur -->
    <div class="editor-toolbar">
        <button type="button" @click="insertBold" class="toolbar-btn" title="Gras">
            <strong>B</strong>
        </button>
        <button type="button" @click="insertItalic" class="toolbar-btn" title="Italique">
            <em>I</em>
        </button>
        <button type="button" @click="insertCode" class="toolbar-btn" title="Code">
            <code>&lt;/&gt;</code>
        </button>
        <button type="button" @click="insertLink" class="toolbar-btn" title="Lien">
            <img src="/files/img/link.svg" class="icon">
        </button>
        <button type="button" @click="insertHeading" class="toolbar-btn" title="Titre">
            H
        </button>
        <div class="toolbar-separator"></div>
        <button type="button" @click="$refs.imageUpload.click()" class="toolbar-btn toolbar-btn-primary" title="Insérer une image">
            <img src="/files/img/camera.svg" class="icon"> Image
        </button>
        <input type="file" 
               x-ref="imageUpload" 
               @change="uploadImage($event)" 
               accept="image/*" 
               style="display: none;">
    </div>
    
    <textarea x-model="post.content" 
              x-ref="contentEditor"
              @input="updatePreview"
              id="content" 
              class="form-control"
              placeholder="# Votre titre principal..."
              required></textarea>
              
    <!-- Zone de progression d'upload -->
    <div x-show="uploading" class="upload-progress">
        <div class="progress-bar">
            <div class="progress-fill" :style="`width: ${uploadProgress}%`"></div>
        </div>
        <span class="progress-text">Upload en cours... <span x-text="uploadProgress"></span>%</span>
    </div>
    
    <div class="form-help">
        <strong>Support Markdown :</strong> **gras**, *italique*, `code`, [liens](url), images, listes, etc.
        <br>Cliquez sur <img src="/files/img/camera.svg" class="icon"> pour uploader une image (max 5MB).
    </div>
</div>
            </div>

            <div class="form-sidebar">
                <!-- Actions de sauvegarde -->
                <div class="sidebar-card">
                    <h3 class="sidebar-title"><img src="/files/img/floppy.svg" class="icon"> Publication</h3>
                    
                    <div x-show="saveStatus" class="save-status" :class="saveStatus" x-text="saveMessage"></div>
                    
                    <div class="save-actions">
                        <button type="submit" 
                                :disabled="saving || !post.title.trim() || !post.content.trim()" 
                                class="btn btn-success">
                            <span x-show="!saving">{{ if .isEdit }}<img src="/files/img/floppy.svg" class="icon"> Mettre à jour{{ else }}<img src="/files/img/rocket.svg" class="icon"> Publier l'article{{ end }}</span>
                            <span x-show="saving"><img src="/files/img/hourglass.svg" class="icon"> Enregistrement...</span>
                        </button>
                        
                        <a href="/admin/posts" class="btn btn-primary"><img src="/files/img/cross.svg" class="icon"> Annuler</a>
                        
                        {{ if .isEdit }}
                        <button type="button" 
                                @click="confirmDelete" 
                                class="btn btn-danger">
                            <img src="/files/img/waste.svg" class="icon"> Supprimer l'article
                        </button>
                        {{ end }}
                    </div>
                </div>

                <!-- Auteur -->
                {{ if not .isEdit }}
                <div class="sidebar-card">
                    <h3 class="sidebar-title"><img src="/files/img/bust.svg" class="icon"> Auteur</h3>
                    <input x-model="post.author" 
                           type="text" 
                           class="form-control"
                           placeholder="Nom de l'auteur">
                    <div class="form-help">Laissez vide pour utiliser votre nom d'utilisateur</div>
                </div>
                {{ end }}

                <!-- Category -->
                <div class="sidebar-card">
                    <h3 class="sidebar-title"><img src="/files/img/label.svg" class="icon"> Catégorie</h3>
                    <div class="tags-input">
                        <select x-model="post.category" class="tag-input">
                            <option value="">--Aucune--</option>
                            {{ .optionsCategory }}
                        </select>
                    </div>
                </div>

                <!-- Tags -->
                <div class="sidebar-card">
                    <h3 class="sidebar-title"><img src="/files/img/label.svg" class="icon"> Tags</h3>
                    <div class="tags-input" @click="$refs.tagInput.focus()">
                        <template x-for="(tag, index) in post.tags" :key="index">
                            <span class="tag-item">
                                <span x-text="tag"></span>
                                <span class="tag-remove" @click="removeTag(index)"><img src="/files/img/x.svg" class="icon"></span>
                            </span>
                        </template>
                        <input x-ref="tagInput"
                               x-model="newTag"
                               @keydown.enter.prevent="addTag"
                               @keydown.comma.prevent="addTag"
                               @keydown.space.prevent="addTag"
                               type="text"
                               class="tag-input"
                               placeholder="Ajouter des tags...">
                    </div>
                    <div class="form-help">Appuyez sur Entrée, Espace ou Virgule pour ajouter un tag</div>
                </div>

                <!-- Aperçu -->
                <div class="sidebar-card">
                    <h3 class="sidebar-title"><img src="/files/img/eye.svg" class="icon"> Aperçu en temps réel</h3>
                    <div class="preview-area" x-html="preview"></div>
                </div>
            </div>
        </div>
    </form>
</div>
{{ end }}

{{ define "admin_post_form_scripts" }}
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('postForm', () => ({
        post: {
            title: {{ if .isEdit }}'{{ .post.Title }}'{{ else }}''{{ end }},
            content: {{ if .isEdit }}`{{ .post.Content }}`{{ else }}''{{ end }},
            excerpt: {{ if .isEdit }}'{{ .post.Excerpt }}'{{ else }}''{{ end }},
            author: {{ if .isEdit }}'{{ .post.Author }}'{{ else }}''{{ end }},
            category: {{ if .isEdit }}'{{ .post.Category }}'{{ else }}''{{ end }},
            tags: {{ if .isEdit }}{{ .post.TagsList | jsonify }}{{ else }}[]{{ end }}
        },
        uploading: false,
        uploadProgress: 0,
        newTag: '',
        preview: '',
        saving: false,
        saveStatus: '',
        saveMessage: '',
        isEdit: {{ .isEdit }},
        postId: {{ if .isEdit }}{{ .post.ID }}{{ else }}null{{ end }},

        init() {
            this.updatePreview();
            
            // Auto-save toutes les 30 secondes si le contenu a changé
            setInterval(() => {
                if (this.isEdit && this.hasUnsavedChanges()) {
                    this.autoSave();
                }
            }, 30000);
        },

        hasUnsavedChanges() {
            // Logique simple pour détecter les changements
            return this.post.title.length > 0 && this.post.content.length > 0;
        },

        async autoSave() {
            if (this.saving) return;
            
            this.saveStatus = 'saving';
            this.saveMessage = 'Sauvegarde automatique...';
            
            try {
                const response = await fetch(`/admin/posts/${this.postId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(this.post)
                });

                if (response.ok) {
                    this.saveStatus = 'saved';
                    this.saveMessage = 'Brouillon sauvegardé automatiquement';
                    setTimeout(() => {
                        this.saveStatus = '';
                    }, 3000);
                }
            } catch (error) {
                console.error('Erreur auto-save:', error);
            }
        },

        addTag() {
            const tag = this.newTag.trim().toLowerCase();
            if (tag && !this.post.tags.includes(tag)) {
                this.post.tags.push(tag);
                this.newTag = '';
            }
        },

        removeTag(index) {
            this.post.tags.splice(index, 1);
        },

        updatePreview() {
            // Rendu Markdown simplifié pour la prévisualisation
            let html = this.post.content
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/gim, '<em>$1</em>')
                .replace(/`(.*?)`/gim, '<code>$1</code>')
                .replace(/^\> (.*$)/gim, '<blockquote>$1</blockquote>')
                .replace(/^\- (.*$)/gim, '<li>$1</li>')
                .replace(/\[([^\]]+)\]\(([^)]+)\)/gim, '<a href="$2">$1</a>')
                .replace(/\n\n/gim, '</p><p>')
                .replace(/\n/gim, '<br>');
            
            // Wrap les listes
            html = html.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
            
            this.preview = html ? '<p>' + html + '</p>' : '<p><em>La prévisualisation apparaîtra ici...</em></p>';
        },

    async uploadImage(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Vérifier le type
        if (!file.type.startsWith('image/')) {
            window.showNotification('Veuillez sélectionner une image', 'error');
            return;
        }

        // Vérifier la taille (10MB)
        if (file.size > 10 * 1024 * 1024) {
            window.showNotification('Image trop grande (max 10MB)', 'error');
            return;
        }

        this.uploading = true;
        this.uploadProgress = 0;

        const formData = new FormData();
        formData.append('image', file);

        try {
            // Simuler la progression (pour une meilleure UX)
            const progressInterval = setInterval(() => {
                if (this.uploadProgress < 90) {
                    this.uploadProgress += 10;
                }
            }, 100);

            const response = await fetch('/admin/upload/image', {
                method: 'POST',
                body: formData
            });

            clearInterval(progressInterval);
            this.uploadProgress = 100;

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Erreur upload');
            }

            const data = await response.json();
            
            // Insérer le markdown de l'image dans le textarea
            const imageMarkdown = `![${file.name}](${data.url})\n`;
            this.insertAtCursor(imageMarkdown);
            
            window.showNotification('Image uploadée avec succès', 'success');
            
            // Réinitialiser l'input file
            this.$refs.imageUpload.value = '';
            
        } catch (error) {
            console.error('Erreur upload:', error);
            window.showNotification('Erreur lors de l\'upload: ' + error.message, 'error');
        } finally {
            this.uploading = false;
            this.uploadProgress = 0;
        }
    },

    insertAtCursor(text) {
        const textarea = this.$refs.contentEditor;
        const startPos = textarea.selectionStart;
        const endPos = textarea.selectionEnd;
        
        this.post.content = 
            this.post.content.substring(0, startPos) +
            text +
            this.post.content.substring(endPos);
        
        // Repositionner le curseur
        this.$nextTick(() => {
            textarea.selectionStart = startPos + text.length;
            textarea.selectionEnd = startPos + text.length;
            textarea.focus();
            this.updatePreview();
        });
    },

    // Méthodes pour la toolbar
    insertBold() {
        const selection = this.getSelection();
        const text = selection ? `**${selection}**` : '**texte en gras**';
        this.insertAtCursor(text);
    },

    insertItalic() {
        const selection = this.getSelection();
        const text = selection ? `*${selection}*` : '*texte en italique*';
        this.insertAtCursor(text);
    },

    insertCode() {
        const selection = this.getSelection();
        const text = selection ? `\`${selection}\`` : '`code`';
        this.insertAtCursor(text);
    },

    insertLink() {
        const selection = this.getSelection();
        const text = '[' + (selection || 'texte du lien') + '](https://exemple.com)';
        this.insertAtCursor(text);
    },

    insertHeading() {
        const selection = this.getSelection();
        const text = '## ' + (selection || 'Titre');
        this.insertAtCursor(text);
    },

    getSelection() {
        const textarea = this.$refs.contentEditor;
        return this.post.content.substring(
            textarea.selectionStart,
            textarea.selectionEnd
        );
    },

        async savePost() {
            this.saving = true;
            this.saveStatus = 'saving';
            this.saveMessage = 'Sauvegarde en cours...';
            
            try {
                const url = this.isEdit ? `/admin/posts/${this.postId}` : '/admin/posts';
                const method = this.isEdit ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(this.post)
                });

                const data = await response.json();

                if (response.ok) {
                    this.saveStatus = 'saved';
                    this.saveMessage = data.message;
                    window.showNotification(data.message, 'success');
                    
                    if (!this.isEdit && data.post_id) {
                        // Rediriger vers l'édition du nouvel article
                        setTimeout(() => {
                            window.location.href = `/admin/posts/${data.post_id}/edit`;
                        }, 1500);
                    } else {
                        // Rester sur la page
                        setTimeout(() => {
                            this.saveStatus = '';
                        }, 3000);
                    }
                } else {
                    this.saveStatus = 'error';
                    this.saveMessage = 'Erreur: ' + data.error;
                    window.showNotification('Erreur: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                this.saveStatus = 'error';
                this.saveMessage = 'Erreur de connexion';
                window.showNotification('Erreur lors de la sauvegarde', 'error');
            } finally {
                this.saving = false;
            }
        },

        confirmDelete() {
            if (confirm(`Êtes-vous sûr de vouloir supprimer l'article "${this.post.title}" ?\n\n⚠️ Cette action est irréversible !`)) {
                this.deletePost();
            }
        },

        async deletePost() {
            try {
                const response = await fetch(`/admin/posts/${this.postId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    window.showNotification('Article supprimé avec succès', 'success');
                    setTimeout(() => {
                        window.location.href = '/admin/posts';
                    }, 1000);
                } else {
                    window.showNotification('Erreur: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Erreur suppression:', error);
                window.showNotification('Erreur lors de la suppression', 'error');
            }
        }
    }));
});
</script>
{{ end }}