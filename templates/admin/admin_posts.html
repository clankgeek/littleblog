{{ define "admin_posts" }}
<!DOCTYPE html>
<html lang="fr">
<head>
    {{ template "head" . }}
    <style>
        {{.theme | safeCSS}}
    </style>
    <link rel="stylesheet" href="/static/css/admin_header.css">
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/footer.css">
    <link rel="stylesheet" href="/static/css/admin_posts.css">
</head>
<body>
    {{ template "admin_header" . }}
    <main class="main">
        {{ template "admin_posts_content" . }}
    </main>
    {{ template "footer" . }}
    {{ template "admin_posts_scripts" . }}
    <script src="static/js/common.js"></script>
</body>
</html>
{{ end }}
{{ define "admin_posts_content" }}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">ğŸ“š Gestion des Articles</h1>
        <a href="/admin/posts/new" class="btn btn-success">
            â• Nouvel Article
        </a>
    </div>

    <div x-data="postsManager">
        {{- if .posts }}
        <div class="posts-container">
            <div class="posts-header">
                <div class="posts-count">
                    ğŸ“Š <strong>{{ len .posts }}</strong> article{{ if gt (len .posts) 1 }}s{{ end }} total{{ if gt (len .posts) 1 }}aux{{ end }}
                </div>
                <div style="font-size: 0.9em; color: #666;">
                    DerniÃ¨re mise Ã  jour il y a quelques instants
                </div>
            </div>

            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 40%;">ğŸ“ Article</th>
                            <th style="width: 15%;">ğŸ‘¤ Auteur</th>
                            <th style="width: 15%;">ğŸ“… Date</th>
                            <th style="width: 15%;">ğŸ·ï¸ Tags</th>
                            <th style="width: 10%;">ğŸ“Š Stats</th>
                            <th style="width: 25%;">âš™ï¸ Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{- range .posts }}
                        <tr>
                            <td>
                                <div class="post-title">{{ .Title }}</div>
                                <div class="post-excerpt">{{ .Excerpt }}</div>
                            </td>
                            <td>
                                <strong>{{ .Author }}</strong>
                            </td>
                            <td>
                                <div>{{ .CreatedAt.Format "02/01/2006" }}</div>
                                <div style="font-size: 0.8em; color: #666;">{{ .CreatedAt.Format "15:04" }}</div>
                            </td>
                            <td>
                                <div class="post-tags">
                                    {{- range .TagsList }}
                                    <span class="tag">{{ . }}</span>
                                    {{- end }}
                                </div>
                            </td>
                            <td>
                                <div class="stats-cell">
                                    <div class="stat">â¤ï¸ {{ .LikeCount }}</div>
                                    <div class="stat">ğŸ’¬ {{ len .Comments }}</div>
                                </div>
                            </td>
                            <td>
                                <div class="actions">
                                    <a href="/post/{{ .ID }}" class="btn btn-primary btn-sm" target="_blank" title="Voir l'article">
                                        ğŸ‘ï¸
                                    </a>
                                    <a href="/admin/posts/{{ .ID }}/edit" class="btn btn-warning btn-sm" title="Ã‰diter">
                                        âœï¸
                                    </a>
                                    <button @click="confirmDelete({{ .ID }}, '{{ .Title | escapeJS}}')" class="btn btn-danger btn-sm" title="Supprimer">ğŸ—‘ï¸</button>
                                </div>
                            </td>
                        </tr>
                        {{- end }}
                    </tbody>
                </table>
            </div>
        </div>
        {{- else }}
        <div class="posts-container">
            <div class="empty-state">
                <div class="empty-icon">ğŸ“</div>
                <h3 class="empty-title">Aucun article pour le moment</h3>
                <p class="empty-description">Commencez par crÃ©er votre premier article pour partager vos idÃ©es !</p>
                <a href="/admin/posts/new" class="btn btn-success btn-lg">
                    â• CrÃ©er le premier article
                </a>
            </div>
        </div>
        {{- end }}

        <!-- Modal de confirmation -->
        <div x-show="showDeleteModal" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             class="modal-overlay" 
             @click.self="showDeleteModal = false">
            <div class="modal"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform scale-95"
                 x-transition:enter-end="opacity-100 transform scale-100">
                <div class="modal-icon">ğŸ—‘ï¸</div>
                <h3 class="modal-title">Confirmer la suppression</h3>
                <div class="modal-content">
                    <p>ÃŠtes-vous absolument sÃ»r de vouloir supprimer cet article ?</p>
                    <div class="modal-target" x-text="deleteTarget.title"></div>
                    <div class="modal-warning">
                        âš ï¸ Cette action est <strong>irrÃ©versible</strong> !<br>
                        Tous les commentaires et likes seront Ã©galement supprimÃ©s.
                    </div>
                </div>
                <div class="modal-actions">
                    <button @click="showDeleteModal = false" class="btn btn-primary">
                        âŒ Annuler
                    </button>
                    <button @click="deletePost" 
                            :disabled="deleting" 
                            class="btn btn-danger">
                        <span x-show="!deleting">ğŸ—‘ï¸ Supprimer dÃ©finitivement</span>
                        <span x-show="deleting">â³ Suppression...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{{ end }}

{{ define "admin_posts_scripts" }}
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('postsManager', () => ({
        showDeleteModal: false,
        deleteTarget: { id: null, title: '' },
        deleting: false,

        confirmDelete(id, title) {
            this.deleteTarget = { id, title };
            this.showDeleteModal = true;
        },

        async deletePost() {
            this.deleting = true;

            try {
                const response = await fetch(`/admin/posts/${this.deleteTarget.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    this.showDeleteModal = false;
                    window.showNotification('Article supprimÃ© avec succÃ¨s', 'success');
                    
                    // Recharger la page aprÃ¨s un court dÃ©lai
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    window.showNotification('Erreur: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Erreur suppression:', error);
                window.showNotification('Erreur lors de la suppression', 'error');
            } finally {
                this.deleting = false;
            }
        }
    }));
});
</script>
{{ end }}